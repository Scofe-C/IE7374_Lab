name: Lab 2 - Daily Iris Model Validation

on:
  schedule:
    - cron: '0 1 * * 1-5'  # 9:00 AM Beijing time on weekdays
  push:
    paths:
      - 'GitHub_Action/lab2/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git log on scheduled runs

      - name: Check for recent changes (scheduled runs only)
        id: check_changes
        if: github.event_name == 'schedule'
        run: |
          COUNT=$(git log --oneline --since="24 hours ago" -- "GitHub_Action/lab2" | wc -l)
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Set up Python
        if: github.event_name != 'schedule' || steps.check_changes.outputs.count != '0'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        if: github.event_name != 'schedule' || steps.check_changes.outputs.count != '0'
        run: pip install scikit-learn

      - name: Run Validation
        if: github.event_name != 'schedule' || steps.check_changes.outputs.count != '0'
        id: run_validation
        run: |
          ACC=$(python "GitHub_Action/lab2/check_iris.py")
          echo "accuracy=$ACC" >> $GITHUB_OUTPUT

      - name: Write Job Summary
        if: always() && (github.event_name != 'schedule' || steps.check_changes.outputs.count != '0')
        run: |
          ACC="${{ steps.run_validation.outputs.accuracy }}"
          if [ "${{ steps.run_validation.outcome }}" == "success" ]; then
            STATUS="âœ… Passed"
          else
            STATUS="âŒ Failed"
          fi
          echo "## ðŸ” Iris Model Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Time | $(date) |" >> $GITHUB_STEP_SUMMARY
          echo "| Model Accuracy | $ACC |" >> $GITHUB_STEP_SUMMARY
          echo "| Threshold | 0.95 |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | $STATUS |" >> $GITHUB_STEP_SUMMARY